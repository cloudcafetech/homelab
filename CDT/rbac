apiVersion: v1
kind: ServiceAccount
metadata:
  name: ci-sa
  namespace: kubevirt-images
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ci-crb
subjects:
- kind: ServiceAccount
  name: ci-sa
  namespace: kubevirt-images
roleRef:
  kind: ClusterRole
  name: ci-cr
  apiGroup: rbac.authorization.k8s.io
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ci-cr
rules:
- apiGroups:
  - subresources.kubevirt.io
  resources:
  - virtualmachineinstances/console
  - virtualmachineinstances/vnc
  verbs:
  - get
- apiGroups:
  - kubevirt.io
  resources: 
  - virtualmachines
  - virtualmachineinstances
  - virtualmachineinstancepresets
  - virtualmachineinstancereplicasets
  - virtualmachineinstancemigrations
  verbs:
  - get
  - list
  - watch
  - create
- apiGroups:
  - cdi.kubevirt.io
  resources:
  - datavolume
  verbs:
  - get
  - list
  - watch
  - create  
- apiGroups:
  - *
  resources:
  - pod
  - service
  - persistentvolumes
  - secrets
  - configmaps  
  verbs:
  - get
  - list
  - watch
  - create
- apiGroups:
  - *
  resources:
  - namespaces
  verbs:
  - get
  - list
  - watch 
---
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: ci-sec
  namespace: kubevirt-images
  annotations:
    kubernetes.io/service-account.name: "ci-sa"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: modify-secret
  namespace: kubevirt-images
spec:
  ttlSecondsAfterFinished: 500
  template:
    spec:
      containers:
      - name: kubectl
        securityContext:
          capabilities:
            drop:
              - all
          runAsNonRoot: true
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
        image: p-boss-gitlab-01.eng.tdc.net:5050/public-repositories/shared-services/public-container-image-registry/bitnami/kubectl:1.27.3
        command: ["/bin/sh"]
        args:
          - -c
          - >-
               sleep 60 &&
               kubectl patch secret cd -n kube-system --patch '{"immutable":true}' --token $(KUBE_TOKEN) --insecure-skip-tls-verify -s https://10.96.0.1:443
        env:
        - name: KUBE_TOKEN
          valueFrom:
            secretKeyRef:
              name: ci-sec
              key: token
      restartPolicy: Never
  backoffLimit: 4


   
